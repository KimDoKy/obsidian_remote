---
tags:
  - book
  - linux
---
## 가상화 기능이란?
PC나 서버 등의 물리적인 기기에서 가상 머신을 동작시키는 소프트웨어 기능 및 그런 동작을 돕는 하드웨어 기능의 조합
- 하드웨어를 최대한 활용하기
- 서버 통합
- 레거시 시스템 수명 연장
- 어떤 OS에서 다른 OS를 실행
- 개발, 테스트 환경

---
## 가상화 소프트웨어
가상 머신은 물리 기기에 설치된 가상화 소프트웨어가 생성, 관리, 삭제를 담당한다.

구현 방법
- 하이퍼바이저 가상화 소프트웨어를 설치하는 방법
- 기존 OS를 바탕으로 애플리케이션으로 동작하는 방법 등

소프트웨어
- VM웨어사의 각종 제품
- 오라클사의 virtualbox
- MS사의 Hyper-V
- 시트릭스 시스템즈사의 Xen

가상 머신 생성 ~ 삭제가지의 흐름

- virt-manager: 가상 머신 생성, 관리, 삭제를 지원. 생성후 실행은 QEMU가 담당함
- QEMU: CPU 및 하드웨어 에뮬레이터. KVM과 조합시 CPU 에뮬은 미사용
- KVM(Kernel-based virtual Machine): 리눅스 커널이 제공하는 가상화 기능

1. virt-manager가 새로운 가상 머신 기반 형태를 만듬(CPU 개수, 메모리 용량, 기타 설치 하드웨어 등)
2. virt-manager가 이런 형태를 바탕으로 가상 머신을 생성해서 QEMU를 기동
3. QEMU와 KVM이 연계해서 가상 머신을 필요한 만큼 생성
4. virt-manager가 사용이 끝난 가상 머신을 삭제

---
## 가상화를 지원하는 CPU 기능
- VMX-root 모드: 물리 기기 처리를 처리
- VMX-nonroot 모드: 가상 머신 처리
가상 머신을 처리할 때 하드웨어 접근이나 물리 기기 인터럽트가 발생하면 CPU가 VMX-root모드가 되고 물리 기기 제어로 자동적으로 전환된다.

가상화 지원 기능
- Intel: VT-x
- AMD: SVM
기능은 별 차이 없지만, 기능 구현하는 CPU 레벨의 명령어셋이 다르다.
KVM이 아키텍처별로 다른 부분을 커널이 지원하는 하드웨어 기능 추상화로 해결한다.
```bash
# 1: 유효 / 0: 무효
# CPU 자체의 가상화 기능이 내장되어도 BIOS 등에서 무효화 될 수도 있음
$ egrep -c '^flags.*(vmx|svm)' /proc/cpuinfo
```

### QEMU + KVM 조합

---
## 가상 머신은 호스트 OS에서 어떻게 보이는가?
### 호스트 OS에서 본 게스트 OS
```bash
$ ps ax | grep qemu-system
...
```

이 프로세스는 동작 중인 가상 머신의 실체이다. qemu-system-x86-64 프로세스에 1:1로 대응한다.
XML 파일의 내용을 qemu-system-x86_64 명령어가 해석할 수 있는 형태로 변환해서 인수로 전달한다.

### 여러 머신을 실행하는 경우

---
## 가상화 환경과 프로세스 스케줄링
적어도 VCPU마다 하나 이상의 스레드가 있다.

### 물리 기기에 프로세스가 동작하는 경우

### 통계 정보
가상 머신에 프로세스가 동작할 때, 물리 기기에서 sar, top 명령어 등으로 CPU 통계 정보를 확인

---
## 가상 머신과 메모리 관리
물리 기기의 메모리는 커널 메모리나 프로세스 메모리가 공존한다.
구체적으로는 qemu-system-x86_64 프로세스의 메모리가 된다.
이 프로세스 메모리는 다시, 가상 머신 관리용 메모리와 가상 머신 그 자체에 할당된 메모리로 나뉜다.
가상 머신 관리용 메모리는 하드웨어 에뮬레이션 처리용 코드나 데이터 등에 쓰인다.
가상 머신에 할당된 메모리는 가상 머신 내부에 있는 커널이나 프로세스 메모리에 쓰인다.

### 가상 머신이 사용하는 메모리

---
## 가상 머신과 저장 장치
디스크 이미지: /var/lib/libvirt/images/ubuntu2004.qcow2
### 가상 머신과 저장소 입출력
![[Pasted image 20230922190522.png]]

![[Pasted image 20230922190539.png]]

가상화 머신은 물리 기기에 비해 저장소 입출력 성능이 나쁘다.
이런 문제를 KVM은 반가상화(Para Virtualization)으로 입출력 속도를 향상시킨다.

물리 기기에 있는 가상 디스크 이미지는 다른 파일과 파일 시스템을 공유한다.
따라서 게스트 OS의 저장소 입출력 성능은 디스크 이미지가 존재하는 파일 시스템의 입출력에 영향을 받는다. 이런 문제 때문에 파일을 사용하는 대신 저장 장치 하나를 통째로 가상 디스크 이미지로 사용하는 경우가 많다.
### 저장 장치 쓰기와 페이지 캐시
옵션에 따라 다르다.
- writeback: 쓰기 작업은 비동기적으로 이루어지고 페이지 캐시를 사용
- writethrough: 쓰기 작업은 동기화, 페이지 캐시를 사용
### 반가상화 장치와 virtio-blk
- 반가상화
	- 가상 머신에서 하드웨어를 완전히 에뮬레이션하는 대신 가상화 소프트웨어와 가상 머신이 특별한 인터페이스로 접속해서 성능을 개선하는 기술
	- 반가상화 장치: 이 기술을 사용하는 저장 장치
	- 반가상화 드라이버
### virtio-blk 구조
호스트 OS와 게스트 OS가 공유하는 캐시를 사용해서 virtio 장치에 접근해서 입출력 속도를 향상
1. 게스트 OS의 virtio-blk 드라이버 큐에 명령어를 삽입
2. virtio-blk 드라이버에서 호스트 OS에 제어를 넘김
3. 호스트 OS의 가상화 소프트웨어가 큐에서 명령어를 꺼내서 처리
4. 가상화 소프트웨어가 가상 머신에 제어를 넘김
5. virtio-blk 장치는 명령어 실행 결과를 받음

1에서 다수의 명령어를 삽입할 수 있기 때문에 완전 가상화 장치보다 빠르게 동작한다.

![[Pasted image 20230922191602.png]]

![[Pasted image 20230922191619.png]]

---
PCI passthrough는 PCI 장치를 가상 머신에서 직접 다루는 기술이다
PCI passthrough를 사용하면 게스트 OS에서 호스트 입출력과 같은 입출력 성능을 얻을 수 있다.

![[Pasted image 20230922191817.png]]

---
#linux 